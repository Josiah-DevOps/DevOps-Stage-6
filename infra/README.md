# Infrastructure Directory

This directory contains all infrastructure-as-code and automation for the DevOps Stage 6 TODO Application.

## Structure

```
infra/
├── terraform/          # Infrastructure provisioning
│   ├── main.tf        # Main infrastructure resources
│   ├── variables.tf   # Input variables
│   ├── outputs.tf     # Output values
│   ├── backend.tf     # Remote state configuration
│   └── inventory.tpl  # Ansible inventory template
├── ansible/           # Configuration management
│   ├── playbook.yml   # Main playbook
│   ├── ansible.cfg    # Ansible configuration
│   ├── group_vars/    # Group variables
│   │   └── all.yml    # Variables for all hosts
│   ├── inventory/     # Dynamic inventory (generated by Terraform)
│   └── roles/         # Ansible roles
│       ├── dependencies/  # Install Docker, Git, etc.
│       └── deploy/        # Deploy application
└── README.md          # This file
```

## Prerequisites

1. **AWS Account** with appropriate permissions
2. **AWS CLI** configured with credentials
3. **Terraform** >= 1.0
4. **Ansible** >= 2.9
5. **SSH Key Pair** for server access
6. **S3 Bucket** for Terraform state (configured in `backend.tf`)

## Quick Start

### 1. Configure Terraform Variables

Create `terraform/terraform.tfvars`:

```hcl
aws_region          = "eu-north-1"
instance_type       = "t3.medium"
ssh_public_key      = "ssh-ed25519 AAAA... your-email@example.com"
ssh_private_key_path = "~/.ssh/id_ed25519"
domain_name         = "your-domain.com"
email               = "your-email@example.com"
```

### 2. Deploy Infrastructure

```bash
cd terraform
terraform init
terraform plan
terraform apply -auto-approve
```

This will:
- Provision EC2 instance
- Configure security groups
- Generate Ansible inventory
- Run Ansible playbooks automatically
- Deploy the application

### 3. Verify Deployment

```bash
# Check Terraform outputs
terraform output

# SSH into server
ssh -i ~/.ssh/id_ed25519 ubuntu@<instance-ip>

# Check containers
docker compose ps
```

## CI/CD Workflows

### Infrastructure Workflow (`.github/workflows/infrastructure.yml`)

**Triggers:**
- Changes to `infra/terraform/**`
- Changes to `infra/ansible/**`
- Manual dispatch

**Features:**
- Drift detection via `terraform plan`
- Email notifications on drift
- Manual approval required for changes
- Automatic apply if no drift

### Application Deployment Workflow (`.github/workflows/deploy.yml`)

**Triggers:**
- Changes to any service code
- Changes to `docker-compose.yml`
- Changes to `traefik/**`
- Manual dispatch

**Features:**
- Pulls latest code on server
- Rebuilds containers
- Verifies deployment
- Email notifications

## Idempotency

All infrastructure and deployment code is idempotent:

- **Terraform**: Uses proper triggers and state management
- **Ansible**: Uses idempotent modules and conditional logic
- **Docker**: Only rebuilds/restarts when code changes

### Terraform Idempotency

The `null_resource` for Ansible uses file hashes as triggers:

```hcl
triggers = {
  instance_id       = aws_instance.app_server.id
  playbook_hash     = filemd5("../ansible/playbook.yml")
  dependencies_hash = filemd5("../ansible/roles/dependencies/tasks/main.yml")
  deploy_hash       = filemd5("../ansible/roles/deploy/tasks/main.yml")
}
```

### Ansible Idempotency

- Only deploys when code changes
- Only restarts containers when necessary
- Checks existing state before actions

## Manual Deployment

### Deploy from Local Machine

```bash
# Run Terraform
cd terraform
terraform apply -auto-approve

# Or run Ansible separately
cd ../ansible
ansible-playbook -i inventory/hosts playbook.yml
```

### Deploy to Existing Server

```bash
cd ansible
ansible-playbook -i inventory/hosts playbook.yml \
  -e "github_username=YOUR_USERNAME" \
  -e "force_restart=true"
```

## Drift Detection

The CI/CD pipeline automatically detects infrastructure drift:

1. Runs `terraform plan` with `-detailed-exitcode`
2. Exit code 2 = drift detected
3. Sends email notification
4. Waits for manual approval
5. Applies changes after approval

## Troubleshooting

### SSH Connection Issues

```bash
# Verify key permissions
chmod 600 ~/.ssh/id_ed25519

# Test SSH connection
ssh -i ~/.ssh/id_ed25519 ubuntu@<instance-ip>
```

### Ansible Fails to Connect

```bash
# Check inventory
cat ansible/inventory/hosts

# Test ping
ansible -i ansible/inventory/hosts all -m ping
```

### Containers Not Starting

```bash
# SSH to server
ssh -i ~/.ssh/id_ed25519 ubuntu@<instance-ip>

# Check container status
docker compose ps
docker compose logs

# Check Traefik logs
docker logs traefik
```

### SSL Certificate Issues

```bash
# Check acme.json permissions (must be 600)
ls -la traefik/acme.json

# Check Traefik logs for certificate errors
docker logs traefik | grep -i certificate
```

## Security Considerations

1. **SSH Keys**: Never commit private keys to Git
2. **Secrets**: Use GitHub Secrets for sensitive data
3. **Security Groups**: Restrict access as needed
4. **SSL/TLS**: Automatic Let's Encrypt certificates via Traefik
5. **Container Security**: Run containers with least privileges

## Required GitHub Secrets

Configure these in your repository settings:

- `AWS_ACCESS_KEY_ID`: AWS access key
- `AWS_SECRET_ACCESS_KEY`: AWS secret key
- `SSH_PUBLIC_KEY`: Public SSH key content
- `SSH_PRIVATE_KEY`: Private SSH key content
- `EMAIL_USERNAME`: SMTP username (Gmail)
- `EMAIL_PASSWORD`: SMTP password (Gmail app password)

## Architecture

```
┌─────────────────────────────────────────────────────┐
│                  GitHub Actions                      │
│  (Terraform + Ansible automation)                   │
└────────────────┬────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────┐
│              AWS EC2 Instance                        │
│                                                      │
│  ┌──────────────────────────────────────────────┐  │
│  │            Traefik (Reverse Proxy)            │  │
│  │         (SSL termination & routing)           │  │
│  └────┬─────────────────────────────────────────┘  │
│       │                                              │
│  ┌────┴─────┬────────┬────────┬────────┬────────┐  │
│  │          │        │        │        │        │  │
│  │ Frontend │Auth API│Todos   │Users   │ Log    │  │
│  │  (Vue)   │  (Go)  │API(Node)│API(Java)│Proc   │  │
│  │          │        │        │        │(Python)│  │
│  └──────────┴────────┴────────┴────────┴────────┘  │
│       │          │        │        │        │       │
│       └──────────┴────────┴────────┴────────┘       │
│                      │                               │
│                ┌─────▼─────┐                         │
│                │   Redis   │                         │
│                └───────────┘                         │
└─────────────────────────────────────────────────────┘
```

## Additional Resources

- [Terraform Documentation](https://www.terraform.io/docs)
- [Ansible Documentation](https://docs.ansible.com/)
- [Docker Compose Documentation](https://docs.docker.com/compose/)
- [Traefik Documentation](https://doc.traefik.io/traefik/)
