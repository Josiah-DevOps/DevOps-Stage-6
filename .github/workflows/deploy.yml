name: Application Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'frontend/**'
      - 'auth-api/**'
      - 'todos-api/**'
      - 'users-api/**'
      - 'log-message-processor/**'
      - 'docker-compose.yml'
      - 'traefik/**'
  workflow_dispatch:

env:
  AWS_REGION: eu-north-1

jobs:
  deploy-app:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.0
          terraform_wrapper: false

      - name: Get Server IP
        id: get_ip
        working-directory: infra/terraform
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_github_username: ${{ github.repository_owner }}
        run: |
          terraform init -reconfigure
          
          # Check if infrastructure exists
          if ! terraform state list 2>/dev/null | grep -q "aws_instance.app_server"; then
            echo "âŒ Infrastructure not found! Please run the infrastructure workflow first."
            echo "error=Infrastructure not provisioned" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          SERVER_IP=$(terraform output -raw instance_public_ip 2>/dev/null || echo "")
          if [ -z "$SERVER_IP" ]; then
            echo "âŒ Could not retrieve server IP from Terraform"
            exit 1
          fi
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "âœ… Server IP: $SERVER_IP"

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H ${{ steps.get_ip.outputs.server_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Setup Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Test SSH connectivity
        run: |
          echo "Testing SSH connection to server..."
          for i in {1..10}; do
            if ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no -o ConnectTimeout=5 ubuntu@${{ steps.get_ip.outputs.server_ip }} "echo 'SSH Ready'" 2>/dev/null; then
              echo "âœ… SSH connection successful"
              exit 0
            fi
            echo "Waiting for SSH... attempt $i/10"
            sleep 5
          done
          echo "âŒ SSH connection failed. Server may be down or unreachable."
          exit 1

      - name: Create Ansible inventory
        working-directory: infra/ansible
        run: |
          mkdir -p inventory
          cat > inventory/hosts << EOF
          [app_servers]
          ${{ steps.get_ip.outputs.server_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=~/.ssh/id_ed25519 ansible_python_interpreter=/usr/bin/python3
          EOF
          echo "Inventory created:"
          cat inventory/hosts

      - name: Deploy application with Ansible
        working-directory: infra/ansible
        env:
          ANSIBLE_HOST_KEY_CHECKING: "False"
        run: |
          echo "Deploying application..."
          ansible-playbook -i inventory/hosts playbook.yml \
            -e "github_username=${{ github.repository_owner }}" \
            -e "force_restart=true" \
            -v

      - name: Verify deployment
        run: |
          echo "Waiting for application to start..."
          sleep 30
          
          echo "Testing application endpoints..."
          for i in {1..10}; do
            if curl -f -k https://jfive.mooo.com 2>/dev/null; then
              echo "âœ… Application is responding!"
              exit 0
            fi
            echo "Attempt $i/10 failed, retrying..."
            sleep 10
          done
          
          echo "âš ï¸ Warning: Application may not be fully ready yet, but deployment completed"

      - name: Send success email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âœ… Deployment Successful: ${{ github.repository }}"
          to: josiahfavour02@gmail.com
          from: DevOps Stage 6 Alert
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <h2 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                âœ… APPLICATION DEPLOYED SUCCESSFULLY
              </h2>
              
              <div style="background-color: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0;">
                <strong>âœ… Status:</strong> Application is live and running!
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸŒ Application URLs</h3>
              <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <strong>ğŸŒ Frontend:</strong> <a href="https://jfive.mooo.com">https://jfive.mooo.com</a><br>
                <strong>ğŸ” Auth API:</strong> <a href="https://jfive.mooo.com/api/auth/version">https://jfive.mooo.com/api/auth/version</a><br>
                <strong>ğŸ“ Todos API:</strong> <a href="https://jfive.mooo.com/api/todos">https://jfive.mooo.com/api/todos</a><br>
                <strong>ğŸ‘¥ Users API:</strong> <a href="https://jfive.mooo.com/api/users">https://jfive.mooo.com/api/users</a>
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ“‹ Deployment Details</h3>
              <table style="border-collapse: collapse; width: 100%; margin-bottom: 20px;">
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Repository:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.repository }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Branch:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.ref_name }}</td>
                </tr>
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Server IP:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ steps.get_ip.outputs.server_ip }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Run Number:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">#${{ github.run_number }}</td>
                </tr>
              </table>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ‘¤ Commit Information</h3>
              <table style="border-collapse: collapse; width: 100%; margin-bottom: 20px;">
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Commit SHA:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">
                    <code style="background-color: #f6f8fa; padding: 2px 6px; border-radius: 3px;">${{ github.sha }}</code>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Author:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.event.head_commit.author.name }} (${{ github.event.head_commit.author.email }})</td>
                </tr>
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Deployed By:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.actor }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Timestamp:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.event.head_commit.timestamp }}</td>
                </tr>
              </table>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ’¬ Commit Message</h3>
              <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; border-left: 4px solid #0366d6; margin-bottom: 20px;">
                <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${{ github.event.head_commit.message }}</pre>
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ“ Changed Files</h3>
              <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <strong>Added:</strong> ${{ join(github.event.head_commit.added, ', ') || 'None' }}<br>
                <strong>Modified:</strong> ${{ join(github.event.head_commit.modified, ', ') || 'None' }}<br>
                <strong>Removed:</strong> ${{ join(github.event.head_commit.removed, ', ') || 'None' }}
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ”— Quick Links</h3>
              <div style="margin: 20px 0;">
                <a href="https://jfive.mooo.com" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px;">
                  ğŸŒ Visit Application
                </a>
                <a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #0366d6; color: white; text-decoration: none; border-radius: 5px;">
                  ğŸ“ View Commit
                </a>
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #6f42c1; color: white; text-decoration: none; border-radius: 5px;">
                  ğŸ“Š View Logs
                </a>
              </div>
            </body>
            </html>

      - name: Send failure email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "âŒ Deployment Failed: ${{ github.repository }}"
          to: josiahfavour02@gmail.com
          from: DevOps Stage 6 Alert
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <h2 style="color: #d73a49; border-bottom: 2px solid #d73a49; padding-bottom: 10px;">
                âŒ APPLICATION DEPLOYMENT FAILED
              </h2>
              
              <div style="background-color: #f8d7da; border-left: 4px solid #d73a49; padding: 15px; margin: 20px 0;">
                <strong>âŒ Status:</strong> Deployment encountered errors. Immediate action required!
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ“‹ Deployment Details</h3>
              <table style="border-collapse: collapse; width: 100%; margin-bottom: 20px;">
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Repository:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.repository }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Branch:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.ref_name }}</td>
                </tr>
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Failed Job:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.job }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Run Number:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">#${{ github.run_number }}</td>
                </tr>
              </table>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ‘¤ Commit Information</h3>
              <table style="border-collapse: collapse; width: 100%; margin-bottom: 20px;">
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Commit SHA:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">
                    <code style="background-color: #f6f8fa; padding: 2px 6px; border-radius: 3px;">${{ github.sha }}</code>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Author:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.event.head_commit.author.name }} (${{ github.event.head_commit.author.email }})</td>
                </tr>
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Triggered By:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.actor }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Timestamp:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.event.head_commit.timestamp }}</td>
                </tr>
              </table>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ’¬ Commit Message</h3>
              <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; border-left: 4px solid #0366d6; margin-bottom: 20px;">
                <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${{ github.event.head_commit.message }}</pre>
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ“ Changed Files</h3>
              <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <strong>Added:</strong> ${{ join(github.event.head_commit.added, ', ') || 'None' }}<br>
                <strong>Modified:</strong> ${{ join(github.event.head_commit.modified, ', ') || 'None' }}<br>
                <strong>Removed:</strong> ${{ join(github.event.head_commit.removed, ', ') || 'None' }}
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">ğŸ”— Quick Links</h3>
              <div style="margin: 20px 0;">
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #d73a49; color: white; text-decoration: none; border-radius: 5px;">
                  ğŸ” View Error Logs
                </a>
                <a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #0366d6; color: white; text-decoration: none; border-radius: 5px;">
                  ğŸ“ View Commit
                </a>
                <a href="${{ github.server_url }}/${{ github.repository }}/actions" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #6f42c1; color: white; text-decoration: none; border-radius: 5px;">
                  ğŸ“Š All Workflows
                </a>
              </div>
              
              <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">
              
              <p style="color: #666; font-size: 12px;">
                <strong>Troubleshooting Steps:</strong><br>
                1. Check the workflow logs for detailed error messages<br>
                2. Review the changes in the failed commit<br>
                3. Verify all secrets and environment variables are set correctly<br>
                4. Check server connectivity and SSH access<br>
                5. Review docker-compose logs on the server if deployment reached that stage
              </p>
            </body>
            </html>
