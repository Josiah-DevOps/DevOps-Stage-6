name: Infrastructure Deployment with Drift Detection

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:

env:
  AWS_REGION: eu-north-1
  TF_VERSION: 1.6.0

jobs:
  terraform-plan:
    name: Terraform Plan & Drift Detection
    runs-on: ubuntu-latest
    outputs:
      has_drift: ${{ steps.drift_check.outputs.has_drift }}
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init -reconfigure

      - name: Terraform Validate
        working-directory: infra/terraform
        run: terraform validate

      - name: Terraform Plan
        id: plan
        working-directory: infra/terraform
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_github_username: ${{ github.repository_owner }}
        run: |
          set +e
          terraform plan -out=tfplan -detailed-exitcode
          EXIT_CODE=$?
          set -e
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          terraform show -no-color tfplan > plan_output.txt
          exit 0

      - name: Check for Drift
        id: drift_check
        run: |
          EXIT_CODE=${{ steps.plan.outputs.exit_code }}
          if [ "$EXIT_CODE" == "2" ]; then
            echo "has_drift=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Changes detected"
          elif [ "$EXIT_CODE" == "0" ]; then
            echo "has_drift=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No changes needed"
          else
            echo "‚ùå Terraform plan failed"
            exit 1
          fi

      - name: Upload plan output
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infra/terraform/plan_output.txt

      - name: Send Drift Detection Email - Changes Detected
        if: steps.drift_check.outputs.has_drift == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ö†Ô∏è DRIFT ALERT: Infrastructure Changes Detected in ${{ github.repository }}"
          to: josiahfavour02@gmail.com
          from: DevOps Stage 6 Alert
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <h2 style="color: #d73a49; border-bottom: 2px solid #d73a49; padding-bottom: 10px;">
                ‚ö†Ô∏è INFRASTRUCTURE DRIFT DETECTED
              </h2>
              
              <div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0;">
                <strong>‚ö†Ô∏è Action Required:</strong> Manual approval needed before infrastructure changes are applied.
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üìã Workflow Details</h3>
              <table style="border-collapse: collapse; width: 100%; margin-bottom: 20px;">
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Repository:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.repository }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Branch:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.ref_name }}</td>
                </tr>
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Workflow:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.workflow }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Run Number:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">#${{ github.run_number }}</td>
                </tr>
              </table>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üë§ Commit Information</h3>
              <table style="border-collapse: collapse; width: 100%; margin-bottom: 20px;">
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Commit SHA:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">
                    <code style="background-color: #f6f8fa; padding: 2px 6px; border-radius: 3px;">${{ github.sha }}</code>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Author:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.event.head_commit.author.name }} (${{ github.event.head_commit.author.email }})</td>
                </tr>
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Committer:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.event.head_commit.committer.name }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Triggered By:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.actor }}</td>
                </tr>
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Timestamp:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.event.head_commit.timestamp }}</td>
                </tr>
              </table>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üí¨ Commit Message</h3>
              <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; border-left: 4px solid #0366d6; margin-bottom: 20px;">
                <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${{ github.event.head_commit.message }}</pre>
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üìÅ Modified Files</h3>
              <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <strong>Added:</strong> ${{ join(github.event.head_commit.added, ', ') || 'None' }}<br>
                <strong>Modified:</strong> ${{ join(github.event.head_commit.modified, ', ') || 'None' }}<br>
                <strong>Removed:</strong> ${{ join(github.event.head_commit.removed, ', ') || 'None' }}
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üîó Quick Links</h3>
              <div style="margin: 20px 0;">
                <a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #0366d6; color: white; text-decoration: none; border-radius: 5px;">
                  üìù View Commit
                </a>
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px;">
                  ‚úÖ Approve & Deploy
                </a>
                <a href="${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}/infra" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #6f42c1; color: white; text-decoration: none; border-radius: 5px;">
                  üìÇ View Infrastructure
                </a>
              </div>
              
              <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">
              
              <p style="color: #666; font-size: 12px;">
                <strong>Next Steps:</strong><br>
                1. Review the changes in the commit above<br>
                2. Check the Terraform plan in the workflow logs<br>
                3. Click "Approve & Deploy" to proceed with applying infrastructure changes<br>
                4. Or reject the deployment if changes are not authorized
              </p>
            </body>
            </html>

      - name: Send Drift Detection Email - No Changes
        if: steps.drift_check.outputs.has_drift == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ No Infrastructure Drift - Auto-Deploying: ${{ github.repository }}"
          to: josiahfavour02@gmail.com
          from: DevOps Stage 6 Alert
          html_body: |
            <html>
            <body style="font-family: Arial, sans-serif; line-height: 1.6; color: #333;">
              <h2 style="color: #28a745; border-bottom: 2px solid #28a745; padding-bottom: 10px;">
                ‚úÖ NO INFRASTRUCTURE DRIFT DETECTED
              </h2>
              
              <div style="background-color: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0;">
                <strong>‚úÖ Status:</strong> Infrastructure matches desired state. Proceeding automatically.
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üìã Workflow Details</h3>
              <table style="border-collapse: collapse; width: 100%; margin-bottom: 20px;">
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Repository:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.repository }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Branch:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.ref_name }}</td>
                </tr>
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Workflow:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.workflow }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Run Number:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">#${{ github.run_number }}</td>
                </tr>
              </table>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üë§ Commit Information</h3>
              <table style="border-collapse: collapse; width: 100%; margin-bottom: 20px;">
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Commit SHA:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">
                    <code style="background-color: #f6f8fa; padding: 2px 6px; border-radius: 3px;">${{ github.sha }}</code>
                  </td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Author:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.event.head_commit.author.name }} (${{ github.event.head_commit.author.email }})</td>
                </tr>
                <tr style="background-color: #f6f8fa;">
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Triggered By:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.actor }}</td>
                </tr>
                <tr>
                  <td style="padding: 8px; border: 1px solid #ddd;"><strong>Timestamp:</strong></td>
                  <td style="padding: 8px; border: 1px solid #ddd;">${{ github.event.head_commit.timestamp }}</td>
                </tr>
              </table>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üí¨ Commit Message</h3>
              <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; border-left: 4px solid #0366d6; margin-bottom: 20px;">
                <pre style="margin: 0; white-space: pre-wrap; word-wrap: break-word;">${{ github.event.head_commit.message }}</pre>
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üìÅ Modified Files</h3>
              <div style="background-color: #f6f8fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                <strong>Added:</strong> ${{ join(github.event.head_commit.added, ', ') || 'None' }}<br>
                <strong>Modified:</strong> ${{ join(github.event.head_commit.modified, ', ') || 'None' }}<br>
                <strong>Removed:</strong> ${{ join(github.event.head_commit.removed, ', ') || 'None' }}
              </div>
              
              <h3 style="color: #0366d6; margin-top: 25px;">üîó Quick Links</h3>
              <div style="margin: 20px 0;">
                <a href="${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #0366d6; color: white; text-decoration: none; border-radius: 5px;">
                  üìù View Commit
                </a>
                <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px;">
                  üëÄ View Workflow Run
                </a>
                <a href="${{ github.server_url }}/${{ github.repository }}/tree/${{ github.ref_name }}/infra" 
                   style="display: inline-block; padding: 10px 20px; margin: 5px; background-color: #6f42c1; color: white; text-decoration: none; border-radius: 5px;">
                  üìÇ View Infrastructure
                </a>
              </div>
              
              <hr style="margin: 30px 0; border: none; border-top: 1px solid #ddd;">
              
              <p style="color: #666; font-size: 12px;">
                <strong>What Happened:</strong><br>
                ‚Ä¢ Terraform plan detected no infrastructure drift<br>
                ‚Ä¢ Current infrastructure matches the desired state in code<br>
                ‚Ä¢ No changes needed - infrastructure is up to date<br>
                ‚Ä¢ This is an informational notification only
              </p>
            </body>
            </html>

  wait-for-approval:
    name: Wait for Manual Approval
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: needs.terraform-plan.outputs.has_drift == 'true'
    environment: production
    
    steps:
    - name: Manual approval checkpoint
      run: echo "‚úÖ Changes approved"

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan, wait-for-approval]
    if: |
      always() && 
      needs.terraform-plan.result == 'success' && 
      (
        (needs.terraform-plan.outputs.has_drift == 'true' && needs.wait-for-approval.result == 'success') ||
        (needs.terraform-plan.outputs.has_drift == 'false')
      )
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          chmod 700 ~/.ssh
          
          # Validate SSH key format
          if ! grep -q "BEGIN.*PRIVATE KEY" ~/.ssh/id_ed25519; then
            echo "ERROR: Invalid SSH private key format"
            echo "Key must contain proper PEM headers"
            exit 1
          fi
          
          echo "‚úì SSH private key configured successfully"
          
          # Also set up public key for verification
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_ed25519.pub
          chmod 644 ~/.ssh/id_ed25519.pub

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Terraform Init
        working-directory: infra/terraform
        run: terraform init -reconfigure

      - name: Terraform Apply
        working-directory: infra/terraform
        env:
          TF_VAR_ssh_public_key: ${{ secrets.SSH_PUBLIC_KEY }}
          TF_VAR_github_username: ${{ github.repository_owner }}
        run: |
          echo "Applying Terraform changes..."
          terraform apply -auto-approve
          
          echo "‚úÖ Infrastructure provisioned"
          echo "‚úÖ Ansible deployment completed"
          echo "Application should be accessible at: https://jfive.mooo.com"

      - name: Send Success Email
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚úÖ Infrastructure Deployment Successful"
          to: josiahfavour02@gmail.com
          from: DevOps Stage 6 Alert
          body: |
            Infrastructure deployed successfully!
            
            Repository: ${{ github.repository }}
            Application URL: https://jfive.mooo.com

      - name: Send Failure Email
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: "‚ùå Infrastructure Deployment Failed"
          to: josiahfavour02@gmail.com
          from: DevOps Stage 6 Alert
          body: |
            Infrastructure deployment failed!
            
            Check logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
